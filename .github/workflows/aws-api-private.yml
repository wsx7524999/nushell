name: Private AWS API Access

# This workflow is restricted to run only for the repository owner
# It demonstrates the private AWS API functionality

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'AWS Service (e.g., s3, ec2)'
        required: true
        default: 's3'
      region:
        description: 'AWS Region'
        required: true
        default: 'us-east-1'
      method:
        description: 'HTTP Method'
        required: true
        default: 'GET'
      path:
        description: 'API Path'
        required: true
        default: '/'

jobs:
  aws-api-call:
    # Restrict to repository owner only
    if: github.repository == 'wsx7524999/nushell' && github.actor == 'wsx7524999'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1.12.0
      
      - name: Build Nushell with AWS API
        run: cargo build --release --features network
      
      - name: Test AWS API Command
        env:
          # These secrets must be configured in the repository settings
          # by the repository owner. They are not accessible to forked repos.
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # Test the aws api command with the provided inputs
          ./target/release/nu -c "aws api ${{ github.event.inputs.service }} ${{ github.event.inputs.region }} ${{ github.event.inputs.method }} '${{ github.event.inputs.path }}'"
      
      - name: Security Notice
        run: |
          echo "================================="
          echo "SECURITY NOTICE"
          echo "================================="
          echo "This workflow only runs for:"
          echo "  - Repository: wsx7524999/nushell"
          echo "  - Actor: wsx7524999"
          echo ""
          echo "AWS credentials are stored as GitHub Secrets and are:"
          echo "  - NOT accessible in forked repositories"
          echo "  - NOT visible in workflow logs"
          echo "  - Only available to the repository owner"
          echo "================================="
